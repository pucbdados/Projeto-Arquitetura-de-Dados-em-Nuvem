{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Nome do Data Factory",
			"defaultValue": "bdados"
		},
		"AzureDataLakeStorage1_accountKey": {
			"type": "secureString",
			"metadata": "Cadeia de caracteres segura para 'accountKey' de 'AzureDataLakeStorage1'"
		},
		"AzureDataLakeStorage2_accountKey": {
			"type": "secureString",
			"metadata": "Cadeia de caracteres segura para 'accountKey' de 'AzureDataLakeStorage2'"
		},
		"AzureSqlDatabase1_connectionString": {
			"type": "secureString",
			"metadata": "Cadeia de caracteres segura para 'connectionString' de 'AzureSqlDatabase1'"
		},
		"HttpServer_password": {
			"type": "secureString",
			"metadata": "Cadeia de caracteres segura para 'password' de 'HttpServer'"
		},
		"HttpServer1_password": {
			"type": "secureString",
			"metadata": "Cadeia de caracteres segura para 'password' de 'HttpServer1'"
		},
		"HttpServer2_password": {
			"type": "secureString",
			"metadata": "Cadeia de caracteres segura para 'password' de 'HttpServer2'"
		},
		"AzureDataLakeStorage1_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://bdados.dfs.core.windows.net/"
		},
		"AzureDataLakeStorage2_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://bdados.dfs.core.windows.net/"
		},
		"HttpServer_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://imunizacao-es.saude.gov.br/_search"
		},
		"HttpServer_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "imunizacao_public"
		},
		"HttpServer1_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://imunizacao-es.saude.gov.br/search"
		},
		"HttpServer1_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "imunizacao_public"
		},
		"HttpServer2_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://imunizacao-es.saude.gov.br/_search"
		},
		"HttpServer2_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "imunizacao_public"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/Landing')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Copy data1",
						"type": "Copy",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"source": {
								"type": "JsonSource",
								"storeSettings": {
									"type": "HttpReadSettings",
									"requestMethod": "GET"
								},
								"formatSettings": {
									"type": "JsonReadSettings"
								}
							},
							"sink": {
								"type": "JsonSink",
								"storeSettings": {
									"type": "AzureBlobFSWriteSettings"
								},
								"formatSettings": {
									"type": "JsonWriteSettings"
								}
							},
							"enableStaging": false
						},
						"inputs": [
							{
								"referenceName": "SES",
								"type": "DatasetReference",
								"parameters": {}
							}
						],
						"outputs": [
							{
								"referenceName": "Destination_Landing",
								"type": "DatasetReference",
								"parameters": {}
							}
						]
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/SES')]",
				"[concat(variables('factoryId'), '/datasets/Destination_Landing')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/pipeline1')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Data flow1",
						"type": "ExecuteDataFlow",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"dataflow": {
								"referenceName": "dataflow1",
								"type": "DataFlowReference",
								"parameters": {},
								"datasetParameters": {
									"source1": {},
									"sink1": {}
								}
							},
							"staging": {},
							"compute": {
								"coreCount": 8,
								"computeType": "General"
							},
							"traceLevel": "Fine"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"annotations": []
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/dataflows/dataflow1')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/AzureSqlTable1')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "AzureSqlDatabase1",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "AzureSqlTable",
				"schema": [
					{
						"name": "vacina_grupoAtendimento_nome",
						"type": "varchar"
					},
					{
						"name": "vacina_codigo",
						"type": "varchar"
					},
					{
						"name": "paciente_dataNascimento",
						"type": "varchar"
					},
					{
						"name": "ds_condicao_maternal",
						"type": "varchar"
					},
					{
						"name": "paciente_endereco_nmPais",
						"type": "varchar"
					},
					{
						"name": "paciente_racaCor_valor",
						"type": "varchar"
					},
					{
						"name": "sistema_origem",
						"type": "varchar"
					},
					{
						"name": "paciente_id",
						"type": "varchar"
					},
					{
						"name": "paciente_endereco_uf",
						"type": "varchar"
					},
					{
						"name": "paciente_idade",
						"type": "int",
						"precision": 10
					},
					{
						"name": "paciente_endereco_cep",
						"type": "varchar"
					},
					{
						"name": "estabelecimento_valor",
						"type": "varchar"
					},
					{
						"name": "estabelecimento_municipio_codigo",
						"type": "varchar"
					},
					{
						"name": "data_importacao_datalake",
						"type": "varchar"
					},
					{
						"name": "paciente_enumSexoBiologico",
						"type": "varchar"
					},
					{
						"name": "estabelecimento_municipio_nome",
						"type": "varchar"
					},
					{
						"name": "vacina_grupoAtendimento_codigo",
						"type": "varchar"
					},
					{
						"name": "vacina_descricao_dose",
						"type": "varchar"
					},
					{
						"name": "paciente_endereco_nmMunicipio",
						"type": "varchar"
					},
					{
						"name": "vacina_categoria_nome",
						"type": "varchar"
					},
					{
						"name": "vacina_fabricante_nome",
						"type": "varchar"
					},
					{
						"name": "vacina_categoria_codigo",
						"type": "varchar"
					},
					{
						"name": "dt_deleted",
						"type": "varchar"
					},
					{
						"name": "paciente_nacionalidade_enumNacionalidade",
						"type": "varchar"
					},
					{
						"name": "vacina_numDose",
						"type": "varchar"
					},
					{
						"name": "status",
						"type": "varchar"
					},
					{
						"name": "document_id",
						"type": "varchar"
					},
					{
						"name": "vacina_lote",
						"type": "varchar"
					},
					{
						"name": "estalecimento_noFantasia",
						"type": "varchar"
					},
					{
						"name": "paciente_racaCor_codigo",
						"type": "varchar"
					},
					{
						"name": "estabelecimento_razaoSocial",
						"type": "varchar"
					},
					{
						"name": "vacina_nome",
						"type": "varchar"
					},
					{
						"name": "estabelecimento_uf",
						"type": "varchar"
					},
					{
						"name": "vacina_dataAplicacao",
						"type": "varchar"
					},
					{
						"name": "co_condicao_maternal",
						"type": "varchar"
					},
					{
						"name": "paciente_endereco_coPais",
						"type": "varchar"
					},
					{
						"name": "vacina_fabricante_referencia",
						"type": "varchar"
					},
					{
						"name": "paciente_endereco_coIbgeMunicipio",
						"type": "varchar"
					}
				],
				"typeProperties": {
					"schema": "dbo",
					"table": "t_stage_ses"
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/AzureSqlDatabase1')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/Destination_Landing')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "AzureDataLakeStorage1",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileName": "a04f6d56-35a0-4696-a7fa-07e3fb0ac348",
						"folderPath": "landing",
						"fileSystem": "bdados"
					}
				},
				"schema": {
					"type": "object",
					"properties": {
						"took": {
							"type": "integer"
						},
						"timed_out": {
							"type": "boolean"
						},
						"_shards": {
							"type": "object",
							"properties": {
								"total": {
									"type": "integer"
								},
								"successful": {
									"type": "integer"
								},
								"skipped": {
									"type": "integer"
								},
								"failed": {
									"type": "integer"
								}
							}
						},
						"hits": {
							"type": "object",
							"properties": {
								"total": {
									"type": "object",
									"properties": {
										"value": {
											"type": "integer"
										},
										"relation": {
											"type": "string"
										}
									}
								},
								"max_score": {
									"type": "number"
								},
								"hits": {
									"type": "array",
									"items": {
										"type": "object",
										"properties": {
											"_index": {
												"type": "string"
											},
											"_type": {
												"type": "string"
											},
											"_id": {
												"type": "string"
											},
											"_score": {
												"type": "number"
											},
											"_source": {
												"type": "object",
												"properties": {
													"vacina_grupoAtendimento_nome": {
														"type": "string"
													},
													"vacina_codigo": {
														"type": "string"
													},
													"paciente_dataNascimento": {
														"type": "string"
													},
													"ds_condicao_maternal": {
														"type": "null"
													},
													"paciente_endereco_nmPais": {
														"type": "string"
													},
													"paciente_racaCor_valor": {
														"type": "string"
													},
													"sistema_origem": {
														"type": "string"
													},
													"paciente_id": {
														"type": "string"
													},
													"paciente_endereco_uf": {
														"type": "string"
													},
													"paciente_idade": {
														"type": "integer"
													},
													"paciente_endereco_cep": {
														"type": "string"
													},
													"estabelecimento_valor": {
														"type": "string"
													},
													"estabelecimento_municipio_codigo": {
														"type": "string"
													},
													"data_importacao_datalake": {
														"type": "string"
													},
													"paciente_enumSexoBiologico": {
														"type": "string"
													},
													"estabelecimento_municipio_nome": {
														"type": "string"
													},
													"vacina_grupoAtendimento_codigo": {
														"type": "string"
													},
													"vacina_descricao_dose": {
														"type": "string"
													},
													"paciente_endereco_nmMunicipio": {
														"type": "string"
													},
													"vacina_categoria_nome": {
														"type": "string"
													},
													"vacina_fabricante_nome": {
														"type": "string"
													},
													"vacina_categoria_codigo": {
														"type": "string"
													},
													"dt_deleted": {
														"type": "null"
													},
													"paciente_nacionalidade_enumNacionalidade": {
														"type": "string"
													},
													"vacina_numDose": {
														"type": "string"
													},
													"status": {
														"type": "string"
													},
													"document_id": {
														"type": "string"
													},
													"vacina_lote": {
														"type": "string"
													},
													"id_sistema_origem": {
														"type": "string"
													},
													"@timestamp": {
														"type": "string"
													},
													"estalecimento_noFantasia": {
														"type": "string"
													},
													"@version": {
														"type": "string"
													},
													"paciente_racaCor_codigo": {
														"type": "string"
													},
													"estabelecimento_razaoSocial": {
														"type": "string"
													},
													"vacina_nome": {
														"type": "string"
													},
													"estabelecimento_uf": {
														"type": "string"
													},
													"data_importacao_rnds": {
														"type": "string"
													},
													"vacina_dataAplicacao": {
														"type": "string"
													},
													"co_condicao_maternal": {
														"type": "null"
													},
													"paciente_endereco_coPais": {
														"type": "string"
													},
													"vacina_fabricante_referencia": {
														"type": "null"
													},
													"paciente_endereco_coIbgeMunicipio": {
														"type": "string"
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/AzureDataLakeStorage1')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/SES')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"linkedServiceName": {
					"referenceName": "HttpServer",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Json",
				"typeProperties": {
					"location": {
						"type": "HttpServerLocation"
					}
				},
				"schema": {}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/linkedServices/HttpServer')]"
			]
		},
		{
			"name": "[concat(parameters('factoryName'), '/AzureDataLakeStorage1')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('AzureDataLakeStorage1_properties_typeProperties_url')]",
					"accountKey": {
						"type": "SecureString",
						"value": "[parameters('AzureDataLakeStorage1_accountKey')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AzureDataLakeStorage2')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('AzureDataLakeStorage2_properties_typeProperties_url')]",
					"accountKey": {
						"type": "SecureString",
						"value": "[parameters('AzureDataLakeStorage2_accountKey')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AzureSqlDatabase1')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"connectionString": "[parameters('AzureSqlDatabase1_connectionString')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/HttpServer')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "HttpServer",
				"typeProperties": {
					"url": "[parameters('HttpServer_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Basic",
					"userName": "[parameters('HttpServer_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('HttpServer_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/HttpServer1')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "HttpServer",
				"typeProperties": {
					"url": "[parameters('HttpServer1_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Basic",
					"userName": "[parameters('HttpServer1_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('HttpServer1_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/HttpServer2')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "HttpServer",
				"typeProperties": {
					"url": "[parameters('HttpServer2_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Basic",
					"userName": "[parameters('HttpServer2_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('HttpServer2_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/dataflow1')]",
			"type": "Microsoft.DataFactory/factories/dataflows",
			"apiVersion": "2018-06-01",
			"properties": {
				"type": "MappingDataFlow",
				"typeProperties": {
					"sources": [
						{
							"dataset": {
								"referenceName": "Destination_Landing",
								"type": "DatasetReference"
							},
							"name": "source1"
						}
					],
					"sinks": [
						{
							"linkedService": {
								"referenceName": "AzureDataLakeStorage2",
								"type": "LinkedServiceReference"
							},
							"name": "sink1"
						}
					],
					"transformations": [
						{
							"name": "flatten1"
						}
					],
					"scriptLines": [
						"source(output(",
						"          took as integer,",
						"          timed_out as boolean,",
						"          {_shards} as (total as integer, successful as integer, skipped as integer, failed as integer),",
						"          hits as (total as (value as integer, relation as string), max_score as double, hits as ({_index} as string, {_type} as string, {_id} as string, {_score} as double, {_source} as (vacina_grupoAtendimento_nome as string, vacina_codigo as string, paciente_dataNascimento as string, ds_condicao_maternal as string, paciente_endereco_nmPais as string, paciente_racaCor_valor as string, sistema_origem as string, paciente_id as string, paciente_endereco_uf as string, paciente_idade as integer, paciente_endereco_cep as string, estabelecimento_valor as string, estabelecimento_municipio_codigo as string, data_importacao_datalake as string, paciente_enumSexoBiologico as string, estabelecimento_municipio_nome as string, vacina_grupoAtendimento_codigo as string, vacina_descricao_dose as string, paciente_endereco_nmMunicipio as string, vacina_categoria_nome as string, vacina_fabricante_nome as string, vacina_categoria_codigo as string, dt_deleted as string, paciente_nacionalidade_enumNacionalidade as string, vacina_numDose as string, status as string, document_id as string, vacina_lote as string, id_sistema_origem as string, {@timestamp} as string, estalecimento_noFantasia as string, {@version} as string, paciente_racaCor_codigo as string, estabelecimento_razaoSocial as string, vacina_nome as string, estabelecimento_uf as string, data_importacao_rnds as string, vacina_dataAplicacao as string, co_condicao_maternal as string, paciente_endereco_coPais as string, vacina_fabricante_referencia as string, paciente_endereco_coIbgeMunicipio as string))[])",
						"     ),",
						"     allowSchemaDrift: true,",
						"     validateSchema: false,",
						"     ignoreNoFilesFound: false,",
						"     documentForm: 'documentPerLine') ~> source1",
						"source1 foldDown(unroll(hits.hits),",
						"     mapColumn(",
						"          vacina_grupoAtendimento_nome = hits.hits.{_source}.vacina_grupoAtendimento_nome,",
						"          vacina_codigo = hits.hits.{_source}.vacina_codigo,",
						"          paciente_dataNascimento = hits.hits.{_source}.paciente_dataNascimento,",
						"          ds_condicao_maternal = hits.hits.{_source}.ds_condicao_maternal,",
						"          paciente_endereco_nmPais = hits.hits.{_source}.paciente_endereco_nmPais,",
						"          paciente_racaCor_valor = hits.hits.{_source}.paciente_racaCor_valor,",
						"          sistema_origem = hits.hits.{_source}.sistema_origem,",
						"          paciente_id = hits.hits.{_source}.paciente_id,",
						"          paciente_endereco_uf = hits.hits.{_source}.paciente_endereco_uf,",
						"          paciente_idade = hits.hits.{_source}.paciente_idade,",
						"          paciente_endereco_cep = hits.hits.{_source}.paciente_endereco_cep,",
						"          estabelecimento_valor = hits.hits.{_source}.estabelecimento_valor,",
						"          estabelecimento_municipio_codigo = hits.hits.{_source}.estabelecimento_municipio_codigo,",
						"          data_importacao_datalake = hits.hits.{_source}.data_importacao_datalake,",
						"          paciente_enumSexoBiologico = hits.hits.{_source}.paciente_enumSexoBiologico,",
						"          estabelecimento_municipio_nome = hits.hits.{_source}.estabelecimento_municipio_nome,",
						"          vacina_grupoAtendimento_codigo = hits.hits.{_source}.vacina_grupoAtendimento_codigo,",
						"          vacina_descricao_dose = hits.hits.{_source}.vacina_descricao_dose,",
						"          paciente_endereco_nmMunicipio = hits.hits.{_source}.paciente_endereco_nmMunicipio,",
						"          vacina_categoria_nome = hits.hits.{_source}.vacina_categoria_nome,",
						"          vacina_fabricante_nome = hits.hits.{_source}.vacina_fabricante_nome,",
						"          vacina_categoria_codigo = hits.hits.{_source}.vacina_categoria_codigo,",
						"          dt_deleted = hits.hits.{_source}.dt_deleted,",
						"          paciente_nacionalidade_enumNacionalidade = hits.hits.{_source}.paciente_nacionalidade_enumNacionalidade,",
						"          vacina_numDose = hits.hits.{_source}.vacina_numDose,",
						"          status = hits.hits.{_source}.status,",
						"          document_id = hits.hits.{_source}.document_id,",
						"          vacina_lote = hits.hits.{_source}.vacina_lote,",
						"          estalecimento_noFantasia = hits.hits.{_source}.estalecimento_noFantasia,",
						"          paciente_racaCor_codigo = hits.hits.{_source}.paciente_racaCor_codigo,",
						"          estabelecimento_razaoSocial = hits.hits.{_source}.estabelecimento_razaoSocial,",
						"          vacina_nome = hits.hits.{_source}.vacina_nome,",
						"          estabelecimento_uf = hits.hits.{_source}.estabelecimento_uf,",
						"          vacina_dataAplicacao = hits.hits.{_source}.vacina_dataAplicacao,",
						"          co_condicao_maternal = hits.hits.{_source}.co_condicao_maternal,",
						"          paciente_endereco_coPais = hits.hits.{_source}.paciente_endereco_coPais,",
						"          vacina_fabricante_referencia = hits.hits.{_source}.vacina_fabricante_referencia,",
						"          paciente_endereco_coIbgeMunicipio = hits.hits.{_source}.paciente_endereco_coIbgeMunicipio",
						"     ),",
						"     skipDuplicateMapInputs: false,",
						"     skipDuplicateMapOutputs: false) ~> flatten1",
						"flatten1 sink(allowSchemaDrift: true,",
						"     validateSchema: true,",
						"     format: 'parquet',",
						"     fileSystem: 'bdados',",
						"     folderPath: 'raw',",
						"     compressionCodec: 'none',",
						"     umask: 0022,",
						"     preCommands: [],",
						"     postCommands: [],",
						"     skipDuplicateMapInputs: true,",
						"     skipDuplicateMapOutputs: true) ~> sink1"
					]
				}
			},
			"dependsOn": [
				"[concat(variables('factoryId'), '/datasets/Destination_Landing')]",
				"[concat(variables('factoryId'), '/linkedServices/AzureDataLakeStorage2')]"
			]
		}
	]
}